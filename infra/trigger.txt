targetScope = 'resourceGroup'

resource cosmos 'Microsoft.DocumentDB/databaseAccounts@2021-10-15' = {
  name: 'pippai-cosmos'
  location: location
  kind: 'GlobalDocumentDB'
  properties: {
    databaseAccountOfferType: 'Standard'
    locations: [
      {
        locationName: location
        failoverPriority: 0
      }
    ]
  }
}

resource aoai 'Microsoft.CognitiveServices/accounts@2023-07-01' = {
  name: 'pippai-aoai'
  location: location
  sku: {
    name: 'S0'
  }
  kind: 'OpenAI'
  properties: {
    // encryption: {
    //   keySource: 'Microsoft.Keyvault'
    //   keyVaultProperties: {
    //     keyName: 'myKey'
    //     keyVersion: '1'
    //     keyVaultUri: 'https://myvault.vault.azure.net/'
    //   }
    // }
  }
}

resource web 'Microsoft.Web/sites@2022-03-01' = {
  name: 'pippai-web'
  location: location
  properties: {
    serverFarmId: 'myAppServicePlan'
    siteConfig: {
      appSettings: [
        { name: 'AZURE_OPENAI_ENDPOINT',         value: aoai.properties.endpoint },
        { name: 'AOAI_MODEL_GPT4O_DEPLOYMENT',   value: 'gpt4o' },
        { name: 'AOAI_MODEL_GPT41_DEPLOYMENT',   value: 'gpt41' },
        { name: 'AOAI_MODEL_O3MINI_DEPLOYMENT',  value: 'o3-mini' },
        { name: 'AOAI_MODEL_DALLE_DEPLOYMENT',   value: 'dalle3' },
        { name: 'AOAI_MODEL_WHISPER_DEPLOYMENT', value: 'whisper' },
        { name: 'AZUREAI_SEARCH_ENDPOINT',       value: 'https://${search.name}.search.windows.net' },
        { name: 'AZUREAI_SEARCH_KEY',            value: listAdminKeys(search.id, '2023-11-01').primaryKey },
        { name: 'COSMOS_CONNECTION_STRING',      value: listKeys(cosmos.id, '2023-04-15').primaryMasterKey },
        { name: 'STORAGE_CONNECTION_STRING',     value: listKeys(sa.id, '2023-01-01').keys[0].value }
      ]
    }
  }
}

resource bot 'Microsoft.BotService/botServices@2021-05-01' = {
  name: 'pippai-bot'
  location: location
  sku: {
    name: 'F0'
  }
  properties: {
  }
}